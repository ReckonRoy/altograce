<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Packages Management</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f8f8;
            color: #333;
        }

        h1, h2 {
            color: #333;
            text-align: center;
        }

        #button-menu{
            display: flex;
            flex-direction: row;
            margin-top: 50px;
            gap: 2rem;
        }

        button {
            padding: 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #45a049;
        }

        .delete-btn{
            background-color: red;
        }

        form {
            background-color: #fff;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: block;
            margin-top: 20px;
            width: 100%;
        }

        form label {
            display: block;
            margin-top: 10px;
            color: #333;
        }

        form input,
        form textarea,
        form select {
            width: calc(100% - 16px);
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        form button {
            width: 48%;
            margin-right: 2%;
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        form button:last-child {
            margin-right: 0;
        }

        form button.cancel {
            background-color: #bbb;
        }

        form button.cancel:hover {
            background-color: #999;
        }

        .itemTable,
        .serviceTable {
            border-collapse: collapse;
            margin-top: 10px;
        }

        #itemTable{
            display: none;
        }

        #serviceTable{
            display: none;
        }
        
        #overlay{
            position: absolute;
            display: none;
            background-color: black;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            opacity: 0.8;
            z-index: 10;
        }

        table {
            width: fit-content;
            border-collapse: collapse;
            margin-top: 50px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #packageTable{
            display: none;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .package-form-div{
            display: none;
            flex-direction: column;
            position: absolute;
            top: 5%;
            width: 50%;
            margin: 0 25%;
            z-index: 12;
            padding: 10px;
            box-sizing: border-box;
        }

        .package-title{
            background-color: #eeecec;
            padding: 10px 0;
            flex: 1;
            box-sizing: border-box;
            border-radius: 5px;
        }

        .package-form{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            flex-basis: 100%;
        }

        .premium-amount{
            grid-column: 1/3;
        }

        /*policy-benefits div and text area*/
        .premium-class-dta{
            grid-column: 1/3;
        }

        #policy-benefits{
            height: 250px;
        }
        /*END*/

        /*policy form - div and button controls*/
        .premium-class-dco{
            margin-top: 20px;
            border: 1px solid gray;
            box-sizing: border-box;
            padding: 10px 5px;
            border-radius: 5px;
        }

        #cancelPackageButton{
            background-color: pink;
            color: white;
            border: 1px solid white;
        }

        #cancelPackageButton:hover{
            outline: 1px solid red;
        }
        
        /*END*/

        .container {
            width: 80%;
            margin: 0 auto;
        }
        /*-----------------------------------------------------------------------------------------------------*/
        #main-header {
            margin-top: 60px;
            box-sizing: border-box;
            grid-column: 1/3;
            display: flex;
            padding: 20px 0;
            /* Add your main header styles here */
        }
/*---------------------------------------------------------------------------------------------------*/
        /*---------------FLASH MESSAGE STYLES--------------------*/
        #flash-message{
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5%;
            text-align: center;
        }

        .error-flash-message{
            width: 100%;
            color: white;
            border: 1px solid gray;
            background-color: red;
        }

        .success-message{
            width: 100%;
            color: white;
            border: 1px solid gray;
            background-color: green;
        }

        #flash-message-p{
            font-weight: bolder;
            padding: 20px 0;
        }
        
    </style>
</head>

<body>
    <admin-header id="nav-wrapper"></admin-header>
    
    <div id="overlay"></div>
    <div id="flash-message">
        <p id="flash-message-p"></p>    
    </div>
    <!-------------------------------------------------PREMIUM FORMS-------------------------------------------------------------->
    <div id="packageForm" class="package-form-div">
        <h2 id="formTitle" class="package-title"></h2>
        <form id="addPackageForm" class="package-form">
            <div class="premium-class-df">
                <label for="packageName">Package Name:</label>
                <input type="text" id="packageName" name="packageName" required>
            </div>
            <div class="premium-class-df">
                <label for="numMembers">Number of Members Covered:</label>
                <input type="number" id="numMembers" name="numMembers" required>
            </div>
            <div class="premium-class-df">
                <label for="min-age">Minimum Age:</label>
                <input type="number" id="min-age" name="min-age" placeholder="0" required>
            </div>
            <div class="premium-class-df">
                <label for="max-age">Maximum Age:</label>
                <input type="number" id="max-age" name="max-age" placeholder="0" required>
            </div>

            <div class="premium-class-df premium-amount">
                <label for="premium-amount">Monthly Policy Amount:</label>
                <input type="text" placeholder="0.00" id="premium-amount" name="premium-amount" required>
            </div>
            <div class="premium-class-df">
                <label for="lapse-period">Lapse Period:</label>
                <input type="text" id="lapse-period" placeholder="0" required>
            </div>

            <div class="premium-class-df">
                <label for="wait-period">Wait Period:</label>
                <input type="text" id="wait-period" placeholder="0" required>
            </div>

            <div class="premium-class-dta">
                <label for="policy-benefits">Policy Benefits:</label>
                <textarea id="policy-benefits" required></textarea>
            </div>

            <div class="premium-class-dco">
                <button type="button" id="savePackageButton">Save</button>
                <button type="button" id="cancelPackageButton">Cancel</button>
            </div>
        </form>
    </div>

    <div id="edit-plan-div" class="package-form-div">
        <h2 class="package-title">Edit Subscription Plan</h2>
        <form id="edit-plan-form" class="package-form">
            <div class="premium-class-df">
                <label for="e-plan-name">Package Name:</label>
                <input type="text" id="e-plan-name" required>
            </div>
            <div class="premium-class-df">
                <label for="e-member-count-field">Number of Members Covered:</label>
                <input type="number" id="e-member-count-field"required>
            </div>
            <div class="premium-class-df">
                <label for="min-age">Minimum Age:</label>
                <input type="number" id="min-age" name="min-age" placeholder="0" required>
            </div>
            <div class="premium-class-df">
                <label for="max-age">Number of Members Covered:</label>
                <input type="number" id="max-age" name="max-age" placeholder="0" required>
            </div>

            <div class="premium-class-df">
                <label for="e-plan-price">Monthly Policy Amount:</label>
                <input type="text" id="e-premium-amount" required>
            </div>
            <div class="premium-class-df">
                <label for="lapse-period">Lapse Period:</label>
                <input type="text" id="lapse-period" placeholder="0" required>
            </div>

            <div class="premium-class-df">
                <label for="wait-period">Wait Period:</label>
                <input type="text" id="wait-period" placeholder="0" required>
            </div>

            <div class="premium-class-dta">
                <label for="policy-benefits">Policy Benefits:</label>
                <textarea id="policy-benefits" required></textarea>
            </div>

            <div class="premium-class-dco">
                <button type="button" id="edit-plan-button">Update</button>
                <button type="button" id="cancel-plan-button">Cancel</button>
            </div>
        </form>
    </div>
<!--------------------END PREMIUM PLAN--------------------------->
    <!-- Optional Subscription Plan Forms-->

    <div id="optionForm" class="package-form-div">
        <h2 id="optionTitle" class="package-title">Add New Optional Plan</h2>
        <form id="addOptionalPackageForm" class="package-form">
            <div class="premium-class-df">
                <label for="optionaPackageName">Package Name:</label>
                <input type="text" id="optionalPackageName" name="optionalName" required>
            </div>

            <div class="premium-class-df">
                <label for="optionalMembersCount">Members Count:</label>
                <input type="text" id="optionalMembersCount" name="membersCount" required>
            </div>

            <div class="premium-class-df">
                <label for="add-policy-amont">Mothly Policy Amont:</label>
                <input type="number" id="add-policy-amont"required>
            </div>

            <div class="premium-class-dta">
                <label for="policy-benefits">Policy Benefits:</label>
                <textarea id="policy-benefits" required></textarea>
            </div>

            <div class="premium-class-dco">
                <button type="button" id="saveOptionalPackageButton">Save</button>
                <button type="button" id="cancelOptionalPackageButton">Cancel</button>
            </div>
        </form>
    </div>

    <div id="edit-optional-plan-div" class="package-form-div">
        <h2 class="package-title">Edit Subscription Plan</h2>
        <form id="edit-optional-plan-form" class="package-form">
            <label for="e-optional-plan-name">Package Name:</label>
            <input type="text" id="e-optional-plan-name" required>

            <label for="e-optional-member-count">Number of Members Covered:</label>
            <input type="number" id="e-optional-member-count"required>

            <label for="e-optional-plan-price">Price for Package:</label>
            <input type="text" id="e-optional-plan-price" required>

            <button type="button" id="edit-optional-plan-button">Update</button>
            <button type="button" id="cancel-optional-plan-button">Cancel</button>
        </form>
    </div>
    <!-- ______________________________________________________________________________________________________________________ -->

    <div class="container">

        <h1>Product Packages Management</h1>

        <div id="main-header">
        </div>

        <div id="button-menu">
            <button id="addPackageButton">Add New Premium Plan</button>
            <button id="addOptionalButton">Add New Additional Plan</button>
        </div>

    <table id="packageTable">
        <tr>
            <th>Package Name</th>
            <th>Members Covered</th>
            <th>Package Price</th>
            <th>Action</th>
        </tr>
    </table>

    <table id="optionalPackageTable">
        <tr>
            <th>Package Name</th>
            <th>Members Covered</th>
            <th>Package Price</th>
            <th>Action</th>
        </tr>
    </table>

    </div>
    <script type="text/javascript" src="../static/js/admin/header.js" th:src="@{/js/admin/header.js}"></script>
    <script>
        /*-------------------------------------------Flash Message----------------------------------------*/
        let flashMessage = (classValue, messageContent) => {
            let flashMessageDiv = document.getElementById("flash-message");
            flashMessageDiv.className = "";
            flashMessageDiv.style.display = "block";
            let message = document.getElementById("flash-message-p");
            message.textContent = messageContent;
            flashMessageDiv.className = classValue;
            setTimeout(() => {
                flashMessageDiv.style.display = "none";
            }, 3000);
        }
        /*________________________________________________________________________________________________*/

        document.getElementById("optionalPackageTable").style.display = "none";

        // JSON object to hold package data
        var packageData = {};
        let packageId;
        let packageValue;

/*--------------------------------------------PACKAGE--------------------------------------------------*/
    document.getElementById("addPackageButton").addEventListener('click', openPackageForm);
    document.getElementById("cancelPackageButton").addEventListener('click', closePackageForm);

    //Open subscription plan package
    function openPackageForm() {
        document.getElementById("packageForm").style.display = "flex";
        
        // Clear form fields
        document.getElementById("addPackageForm").reset();
        // Reset the form title
        document.getElementById("formTitle").innerText = "Add New Premium Policy Plan";
        //Close option package form
        closeOptionForm();
        const overlay = document.getElementById("overlay");
        if(overlay.style.display === "none")
        {
            overlay.style.display = "block";
        }
    }

    function closePackageForm() {
        document.getElementById("packageForm").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    //validate add premium form
    let errorMessage = "";
    let validatePremiumForm = (packageNameVal, numMembers, minAge, maxAge, premiumAmount, lapsePeriod, waitPeriod) => {
        errorMessage = "";
        let isFormValid;
        if(packageNameVal == "")
        {
            errorMessage += `\n ->Please fill in \"Policy name\" field`;
            isFormValid = false;
        }

        if((numMembers == "") || (numMembers == NaN))
        {
            errorMessage += `\n ->Please fill in "Number of member's" field with a valid digit/number`;
            isFormValid = false;
        }

        if((minAge == "") || (minAge == NaN))
        {
            errorMessage += `\n ->Please fill in "min age" field with a valid digit/number`;
            isFormValid = false;
        }

        if((maxAge == "") || (maxAge == NaN))
        {
            errorMessage += `\n ->Please fill in "max age" field with a valid digit/number`;
            isFormValid = false;
        }

        if((premiumAmount == "") || (premiumAmount == NaN))
        {
            errorMessage += `\n ->Please fill in "Premium amount" field with a valid amount`;
            isFormValid = false;
        }else if(parseFloat(premiumAmount) == 0 || parseFloat(premiumAmount) < 0){
            errorMessage += `\n ->"Premium amount" must not be less than or equals to zero!`;
            isFormValid = false;
        }

        if((lapsePeriod == "") || (lapsePeriod == NaN))
        {
            errorMessage += `\n ->Please fill in "Laspe period" field with a valid digit/number`;
            isFormValid = false;
        }

        if((waitPeriod == "") || (waitPeriod == NaN))
        {
            errorMessage += `\n ->Please fill in "Wait period" field with a valid digit/number`;
            isFormValid = false;
        }

        if(isFormValid === false)
        {
            return false;
        }else{
            return true;
        }
        
    }

    //Save Premium plan policy
    let savePackage = () => {
        // Get form values
        let packageNameVal = document.getElementById("packageName").value;
        let numMembers = document.getElementById("numMembers").value;
        let minAge = document.getElementById("min-age").value;
        let maxAge = document.getElementById("max-age").value;
        let premiumAmount = document.getElementById("premium-amount").value;
        let lapsePeriod = document.getElementById("lapse-period").value;
        let waitPeriod = document.getElementById("wait-period").value;
        let policyBenefits = document.getElementById("policy-benefits").value
        var packageData = {
            packageName: packageNameVal,
            membersCount: numMembers,
            premiumAmount: premiumAmount,
            minAge: minAge,
            maxAge: maxAge,
            lapsePeriod: lapsePeriod,
            waitPeriod: waitPeriod,
            policyBenefits: policyBenefits
        };
        
        //check add premium form validation
        if(validatePremiumForm(packageNameVal, numMembers, minAge, maxAge, premiumAmount, lapsePeriod, waitPeriod) !== true){
            alert(errorMessage);
        }else{
            //fetch api sending data to backend for update
            fetch(`/package/add-package`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(packageData),
            })
            .then(response => {
                if (!response.ok) {
                    return flashMessage("error-flash-message", "Error saving subscription plan");
                }
                return response.json()
            })
            .then(data => {
                //pass message to modal box
                let message = `Package has been successfuly saved`;
                // Update the table with the new data
                updatePackageTable();

                flashMessage("success-message", message);
            })
            closePackageForm();
        }
    }

    document.getElementById("savePackageButton").addEventListener('click', savePackage);
/*____________________________________________________________________________________________________________*/

/*------------------------------------------OPTIONAL PACKAGE--------------------------------------------------*/
    document.getElementById("addOptionalButton").addEventListener('click', openOptionForm);
    document.getElementById("saveOptionalPackageButton").addEventListener('click', saveOptionalPackage);
    document.getElementById("cancelOptionalPackageButton").addEventListener('click', closeOptionForm);

    function openOptionForm() {
        document.getElementById("optionForm").style.display = "flex";
        // Clear form fields
        document.getElementById("addOptionalPackageForm").reset();
        // Reset the form title
        document.getElementById("optionTitle").innerText = "Add New Additional Plan";
        closePackageForm();
        
        //display overlay
        const overlay = document.getElementById("overlay");
        if(overlay.style.display === "none")
        {
            overlay.style.display = "block";
        }
    }

    function closeOptionForm() {
        document.getElementById("optionForm").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        // Clear form fields
        document.getElementById("addOptionalPackageForm").reset();
    }

    /***********************Save Optional Packages**************************/
    function saveOptionalPackage() {
        // Get form values
        var packageName = document.getElementById("optionalPackageName").value;
        var membersCount = document.getElementById("optionalMembersCount").value;
        var packagePrice = document.getElementById("optionalPrice").value;

        var packageData = {
            packageName: packageName,
            membersCount: membersCount,
            price: packagePrice,
        };
        //fetch api sending data to backend for update
        fetch(`/package/add-optional-package/${companyProfile.selectedId}`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(packageData),
        })
        .then(response => {
            if (!response.ok) {
                return flashMessage("error-flash-message", "Error saving optional subscription plan");
            }
            response.json();
        })
        .then(data => {
            let message = `Optional Package has been successfuly saved!`;
            // Update the table with the new data
            optionalPackageTable(companyProfile.selectedId);
            // Close item form
            closeItemForm();
            // Close service form
            closeServiceForm();
            flashMessage("success-message", message)
        })
        
        //close form
        closeOptionForm();
    }
/*________________________________________________________________________________________________________________*/

    let updatePackageTable = (selectedId) => {
        fetch(`/package/packages/${selectedId}`)
        .then(response => response.json())
        .then(data => {
            var table = document.getElementById("packageTable");
            table.style.display = "block";
            // Clear existing rows
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            //store returned object into companies
            data.forEach(package => {
                packageData[package.id] = {
                    packageName: package.packageName,
                    membersCount: package.membersCount,
                    price: package.price,
                    packageType: "standard",
                };

                // Add rows with package data
                var row = table.insertRow(-1);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);

                cell1.innerHTML = package.packageName;
                cell2.innerHTML = package.membersCount;
                cell3.innerHTML = package.price;
                cell4.innerHTML = `<button onclick="editSubscriptionPlan(${package.id})">edit</button> <button class="delete-btn" onclick="deletePackage(${package.id})">delete</button> <button class="show-items" id="${package.id}">show items</button> <button class="add-items" id="${package.id}">add items</button> <button class="add-service" id="${package.id}">add vervice</button>`; 
            });

        })
        .catch(error => {
            var table = document.getElementById("packageTable");
            table.style.display = "none";
        });    
    }

    let optionalPackageTable = (selectedId) => {
        fetch(`/package/optional-packages/${selectedId}`)
        .then(response => response.json())
        .then(data => {
            var table = document.getElementById("optionalPackageTable");
            table.style.display = "block";
            // Clear existing rows
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            //store returned object into companies
            data.forEach(package => {
                packageData[package.id] = {
                    packageName: package.packageName,
                    membersCount: package.membersCount,
                    price: package.price,
                    packageType: 'optional',
                };
                
                // Add rows with package data
                var row = table.insertRow(-1);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);

                cell1.innerHTML = package.packageName;
                cell2.innerHTML = package.membersCount;
                cell3.innerHTML = package.price;
                cell4.innerHTML = `<button onclick="editOptionalSubscriptionPlan(${package.id})">edit</button> <button class="delete-btn" onclick="deleteOptionalPackage(${package.id})">delete</button> <button class="show-items" id="${package.id}">show items</button> <button class="add-opt-items" id="${package.id}">add item</button> <button class="add-service" id="${package.id}">add service</button>`; 
            });

        })
        .catch(error => {
            var table = document.getElementById("packageTable");
            table.style.display = "none";
        });    
    } 

    let deletePackage = (packageId) => {
        fetch(`/package/delete-package/${packageId}`,
        {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                return flashMessage("error-flash-message", "Error deleting subscription plan");
            }
            return response.text();
        })
        .then(data => {
            // Update the table with the modified data
            updatePackageTable(companyProfile.selectedId);
            flashMessage("success-message", data);
        }).catch(error => {
            
        });
    }

    /*DELETE OPTIONAL PACKAGE*/
    let deleteOptionalPackage = (packageId) => {
        fetch(`/package/delete-optional-package/${packageId}`,
        {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                return flashMessage("error-flash-message", "Error deleting optional subscription plan");
            }
            return response.text();
            
        })
        .then(data => {
            // Update the table with the modified data
            optionalPackageTable(companyProfile.selectedId);
            flashMessage("success-message", data);
        })
    }
    // Uncomment the following line if you want the form to be open by default
    // openPackageForm();

/*---------------------------------------------------------------------------------------------------*/
    
/*--------------------------------------Edit Subscription Plan---------------------------------------------------*/

    //Open Edit Form - Subscription Plan
    let editSubscriptionPlan = (packageId) => {
        const packageType =  "standard";
        getSubscriptionPlan(packageId);
    }

    //Open Edit subscription plan package
    let openEditSubscriptionPlan = () => {
        document.getElementById("edit-plan-div").style.display = "flex";
        // Reset the form title
        document.getElementById("formTitle").innerText = "Edit Subscription Plan";
        const overlay = document.getElementById("overlay");
        if(overlay.style.display === "none")
        {
            overlay.style.display = "block";
        }
    }

    let getSubscriptionPlan = (package_id) => {
           
        packageId = package_id;
        //query parameters
        let packageQueryData = {
            id: package_id,
        };

        //fetch api sending data to backend for update
        fetch(`/package/get-plan/${companyProfile.selectedId}`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(packageQueryData),
        })
        .then(response => {
            if (!response.ok) {
                if(response.status === 400){
                    return flashMessage("error-flash-message", "Failed to retrieve plan data!");
                }else{
                    return flashMessage("error-flash-message", "An Error occured please try again later");
                }
            }
            return response.json();
        })
        .then(data => {
            //populate fields with data from server
            let packageName = document.getElementById('e-plan-name');
            packageName.value = data.packageName;

            let membersCount = document.getElementById("e-member-count-field");
            membersCount.value = data.membersCount;

            let price = document.getElementById("e-plan-price");
            price.value = data.price; 

            openEditSubscriptionPlan()
        })
    }

    //update subscription plan - post data to server for updating.
    let updateSubscriptionPlanButton = document.getElementById("edit-plan-button");
    updateSubscriptionPlanButton.addEventListener("click", () => {
        updateSubscriptionPlan();
    });
    
    let updateSubscriptionPlan = () => {
        let formData = {
            id: packageId,
            packageName: document.getElementById('e-plan-name').value,
            membersCount: document.getElementById("e-member-count-field").value,
            price: document.getElementById("e-plan-price").value,
        }
   
        //fetch api sending data to backend for update
        fetch(`/package/update-plan`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
        .then(response => {
            if (!response.ok) {
                return flashMessage("error-flash-message", "Error updating subscription plan");
            }
            return response.json()
        })
        .then(data => {
            //pass message to modal box
            let message = `Subscription-Plan has been updated successfully`;
            // Update the table with the new data
            updatePackageTable();
            
            //close modal
            closeEditSubscriptionPlanModal();

            flashMessage("success-message", message);
        })
    }
    //close edit subscription modal
    let closeEditSubscriptionPlanModal = () => {
        document.getElementById("edit-plan-div").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    document.getElementById("cancel-plan-button").addEventListener('click', closeEditSubscriptionPlanModal);
/*__________________________________________________________________________________________________________________________*/
/*--------------------------------------Edit Optional Subscription Plan---------------------------------------------------*/

//Open Edit Form - Subscription Plan
let editOptionalSubscriptionPlan = (packageId) => {
    getOptionalSubscriptionPlan(packageId);
}

//Open Edit optional subscription plan package
let openEditOptionalSubscriptionPlan = () => {
    document.getElementById("edit-optional-plan-div").style.display = "flex";
    // Reset the form title
    document.getElementById("formTitle").innerText = "Edit Optional Subscription Plan";
    // Close item form
    closeItemForm();
    // Close service form
    closeServiceForm();
    const overlay = document.getElementById("overlay");
    if(overlay.style.display === "none")
    {
        overlay.style.display = "block";
    }
}

let getOptionalSubscriptionPlan = (package_id) => {
    packageId = package_id;
    //query parameters
    let packageQueryData = {
        id: package_id,
    };

    //fetch api sending data to backend for update
    fetch(`/package/get-optional-plan`,{
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(packageQueryData),
    })
    .then(response => {
        if (!response.ok) {
            if(response.status === 400){
                return flashMessage("error-flash-message", "Failed to retrieve plan data!");
            }else{
                return flashMessage("error-flash-message", "An Error occured please try again later");
            }
        }
        return response.json();
    })
    .then(data => {
        //populate fields with data from server
        let packageName = document.getElementById('e-optional-plan-name');
        packageName.value = data.packageName;

        let membersCount = document.getElementById("e-optional-member-count");
        membersCount.value = data.membersCount;

        let price = document.getElementById("e-optional-plan-price");
        price.value = data.price; 

        openEditOptionalSubscriptionPlan();
    })
    
}

//update optional subscription plan - post data to server for updating.
let updateOptionalSubscriptionPlanButton = document.getElementById("edit-optional-plan-button");
    updateOptionalSubscriptionPlanButton.addEventListener("click", () => {
        updateOptionalSubscriptionPlan();
    });
    
    let updateOptionalSubscriptionPlan = () => {
        let formData = {
            id: packageId,
            packageName: document.getElementById('e-optional-plan-name').value,
            membersCount: document.getElementById("e-optional-member-count").value,
            price: document.getElementById("e-optional-plan-price").value,
        }

         
        //fetch api sending data to backend for update
        fetch(`/package/update-optionalplan/}`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
        .then(response => {
            if (!response.ok) {
                return flashMessage("error-flash-message", "Error updating optional subscription plan");
            }
            return response.json()
        })
        .then(data => {
            //pass message to modal box
            let message = `Optional-Subscription-Plan has been updated successfully`;
            // Update the table with the new data
            optionalPackageTable(companyProfile.selectedId);
            
            //close modal
            closeEditOptionalSubscriptionPlanModal();

            flashMessage("success-message", message);
        })
    }
//close edit optional subscription modal
let closeEditOptionalSubscriptionPlanModal = () => {
    document.getElementById("edit-optional-plan-div").style.display = "none";
    document.getElementById("overlay").style.display = "none";
}

document.getElementById("cancel-optional-plan-button").addEventListener('click', closeEditOptionalSubscriptionPlanModal);
/*__________________________________________________________________________________________________________________________*/
    </script>

</body>

</html>
